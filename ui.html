<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTProto Proxy Manager</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --danger: #dc2626;
      --ok: #16a34a;
      --border: rgba(15, 23, 42, 0.12);
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    a { color: var(--accent); text-decoration: none; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display: flex; gap: 16px; align-items: baseline; justify-content: space-between; margin-bottom: 18px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; }
    .sub { color: var(--muted); font-size: 13px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: repeat(12, 1fr); }
      .span-4 { grid-column: span 4; }
      .span-8 { grid-column: span 8; }
      .span-12 { grid-column: span 12; }
    }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: var(--shadow); }
    .card h2 { font-size: 14px; margin: 0 0 10px 0; color: var(--text); }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .row2 { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 600px) { .row2 { grid-template-columns: 1fr 1fr; } }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"] {
      width: 100%;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
    }
    input[type="password"] {
      width: 100%;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
    }
    input[disabled] { opacity: 0.6; cursor: not-allowed; }
    .toggles { display: flex; flex-wrap: wrap; gap: 10px; }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 999px;
      background: #f8fafc;
      user-select: none;
    }
    .toggle input { accent-color: var(--accent); }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 12px; }
    button {
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button.primary { background: rgba(37,99,235,0.10); border-color: rgba(37,99,235,0.35); }
    button.danger { background: rgba(220,38,38,0.08); border-color: rgba(220,38,38,0.35); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .note { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }
    .status { font-size: 12px; color: var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--danger); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid var(--border); padding: 10px 8px; font-size: 13px; }
    th { color: var(--muted); font-weight: 600; }
    code { background: #f1f5f9; padding: 2px 6px; border-radius: 8px; border: 1px solid var(--border); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align: right; }
    .pill { display: inline-flex; gap: 8px; align-items: center; }
    .top-actions { display: flex; gap: 10px; align-items: center; }
    .login-wrap { max-width: 520px; margin: 16px auto 0 auto; }
    .divider { height: 1px; background: var(--border); margin: 12px 0; }
    .kpis { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    @media (min-width: 600px) { .kpis { grid-template-columns: 1fr 1fr 1fr; } }
    .kpi { border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; background: #f8fafc; }
    .kpi .t { font-size: 12px; color: var(--muted); }
    .kpi .v { font-size: 16px; font-weight: 700; margin-top: 4px; }
    .spark { width: 100%; height: 120px; border: 1px solid var(--border); border-radius: 12px; background: #ffffff; overflow: hidden; }
    .spark svg { width: 100%; height: 120px; display: block; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.30);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .modal {
      width: min(560px, 100%);
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .qr {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (min-width: 520px) { .qr { grid-template-columns: 220px 1fr; } }
    .qr-box { width: 220px; height: 220px; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .qr-box img { width: 220px; height: 220px; display: block; }
  </style>
</head>
<body>
<div id="app" class="wrap">
  <header>
    <div>
      <h1>MTProto Proxy Manager</h1>
      <div class="sub">UI работает с REST API прокси. По умолчанию: <code class="mono">/config</code> и <code class="mono">/users</code>.</div>
    </div>
    <div class="top-actions">
      <div class="status" :class="statusClass">{{ statusText }}</div>
      <button v-if="token" @click="logout" :disabled="busy">Выйти</button>
    </div>
  </header>

  <div v-if="!token" class="login-wrap">
    <section class="card">
      <h2>Вход</h2>
      <div class="row2">
        <div>
          <label>Логин</label>
          <input type="text" v-model.trim="login.username" autocomplete="username" placeholder="admin" />
        </div>
        <div>
          <label>Пароль</label>
          <input type="password" v-model.trim="login.password" autocomplete="current-password" placeholder="пароль" />
        </div>
      </div>
      <div class="actions">
        <button class="primary" @click="doLogin" :disabled="busy || !login.username || !login.password">Войти</button>
      </div>
      <div class="note">
        Пароль берётся из переменной окружения <code class="mono">MTPROTO_ADMIN_PASS</code>.
        Если не задан — генерируется при первом запуске и выводится в stderr.
      </div>
      <div class="divider"></div>
      <div class="note">
        API base URL:
        <input type="text" v-model.trim="apiBase" class="mono" style="margin-top:6px;" placeholder="например http://127.0.0.1:8080" />
        <div style="margin-top:6px;">Если UI открыт с того же хоста/порта, оставь пустым.</div>
      </div>
    </section>
  </div>

  <div v-else class="grid">
    <section class="card span-8">
      <h2>Конфигурация</h2>

      <div class="row2">
        <div>
          <label>Порт прокси (runtime менять нельзя)</label>
          <input type="number" v-model.number="cfg.port" disabled />
        </div>
        <div>
          <label>TLS домен</label>
          <input type="text" v-model.trim="cfg.tls_domain" placeholder="например yandex.ru" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Advertising Tag (AD_TAG)</label>
          <input type="text" v-model.trim="cfg.ad_tag" placeholder="32 hex (опционально)" />
          <div class="note">Если включаешь рекламу через @MTProxybot — вставь тег сюда. Иначе оставь пустым.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Режимы</label>
        <div class="toggles">
          <label class="toggle"><input type="checkbox" v-model="cfg.modes.classic" /> classic</label>
          <label class="toggle"><input type="checkbox" v-model="cfg.modes.secure" /> secure</label>
          <label class="toggle"><input type="checkbox" v-model="cfg.modes.tls" /> tls</label>
        </div>
        <div class="note">Прокси автоматически reload-ится после сохранения.</div>
      </div>

      <div class="actions">
        <button class="primary" @click="saveConfig" :disabled="busy">Сохранить</button>
        <button @click="refresh" :disabled="busy">Обновить</button>
      </div>

      <div class="note">
        API base URL:
        <input type="text" v-model.trim="apiBase" class="mono" style="margin-top:6px;" placeholder="например http://127.0.0.1:8080" />
        <div style="margin-top:6px;">Если UI открыт с того же хоста/порта, оставь пустым.</div>
      </div>
    </section>

    <section class="card span-4">
      <h2>Админ аккаунт</h2>
      <div class="row2">
        <div>
          <label>Старый пароль</label>
          <input type="password" v-model.trim="pw.old" autocomplete="current-password" />
        </div>
        <div>
          <label>Новый пароль</label>
          <input type="password" v-model.trim="pw.new" autocomplete="new-password" />
        </div>
      </div>
      <div class="actions">
        <button class="primary" @click="changePassword" :disabled="busy || !pw.old || !pw.new">Сменить пароль</button>
      </div>
    </section>

    <section class="card span-8">
      <h2>Пользователи (USERS)</h2>

      <div class="row">
        <div class="row2">
          <div>
            <label>Имя</label>
            <input type="text" v-model.trim="newUser.name" placeholder="tg" />
          </div>
          <div>
            <label>Secret (32 hex)</label>
            <input type="text" v-model.trim="newUser.secret" placeholder="0123456789abcdef..." class="mono" />
          </div>
        </div>

        <div class="actions">
          <button @click="generateSecret" :disabled="busy">Сгенерировать secret</button>
          <button class="primary" @click="createUser" :disabled="busy || !newUser.name || !newUser.secret">Добавить</button>
        </div>

        <table v-if="userList.length">
          <thead>
            <tr>
              <th>Имя</th>
              <th>Secret</th>
              <th class="right">Действия</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="u in userList" :key="u.name">
              <td class="mono">{{ u.name }}</td>
              <td class="mono">{{ u.secret }}</td>
              <td class="right">
                <span class="pill">
                  <button @click="openQr(u.name)" :disabled="busy">QR</button>
                  <button @click="startEdit(u)" :disabled="busy">Изменить</button>
                  <button class="danger" @click="deleteUser(u.name)" :disabled="busy">Удалить</button>
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <div v-else class="note">Пользователей нет.</div>
      </div>

      <div v-if="editUser.open" class="card" style="margin-top:14px; padding: 14px;">
        <h2 style="margin-bottom:10px;">Изменить пользователя: <span class="mono">{{ editUser.name }}</span></h2>
        <label>Новый secret (32 hex)</label>
        <input type="text" v-model.trim="editUser.secret" class="mono" />
        <div class="actions">
          <button class="primary" @click="applyEdit" :disabled="busy || !editUser.secret">Сохранить</button>
          <button @click="cancelEdit" :disabled="busy">Отмена</button>
        </div>
      </div>

      <div class="note" style="margin-top:10px;">
        Подсказка: Secret — 32 hex-символа. После добавления/изменения прокси reload-ится автоматически.
      </div>
    </section>

    <section class="card span-4">
      <h2>API ключи</h2>

      <div class="row2">
        <div>
          <label>Название (опционально)</label>
          <input type="text" v-model.trim="keyCreate.name" placeholder="например ci" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="primary" @click="createKey" :disabled="busy">Создать ключ</button>
        </div>
      </div>

      <div v-if="createdKey.token" class="note" style="margin-top:10px;">
        Новый ключ (показывается один раз):
        <div class="mono" style="margin-top:6px; word-break: break-all;">{{ createdKey.token }}</div>
      </div>

      <table v-if="apiKeys.length" style="margin-top:10px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Prefix</th>
            <th>Created</th>
            <th class="right">Действия</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="k in apiKeys" :key="k.id">
            <td class="mono">{{ k.id }}</td>
            <td>{{ k.name }}</td>
            <td class="mono">{{ k.prefix }}</td>
            <td class="mono">{{ fmtTs(k.created_at) }}</td>
            <td class="right">
              <button class="danger" @click="deleteKey(k.id)" :disabled="busy">Удалить</button>
            </td>
          </tr>
        </tbody>
      </table>
      <div v-else class="note" style="margin-top:10px;">Ключей пока нет.</div>

      <div class="actions" style="margin-top:10px;">
        <button @click="loadKeys" :disabled="busy">Обновить список</button>
      </div>
    </section>

    <section class="card span-12">
      <h2>Мониторинг</h2>

      <div class="row2">
        <div>
          <label>Окно</label>
          <select v-model.number="mon.windowMin" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff;">
            <option :value="15">15 минут</option>
            <option :value="60">1 час</option>
            <option :value="360">6 часов</option>
            <option :value="1440">24 часа</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button @click="loadMonitoring" :disabled="busy">Обновить</button>
        </div>
      </div>

      <div class="kpis" v-if="mon.summary.now">
        <div class="kpi">
          <div class="t">Uptime</div>
          <div class="v mono">{{ fmtDur(mon.summary.now.uptime) }}</div>
        </div>
        <div class="kpi">
          <div class="t">Текущие соединения</div>
          <div class="v mono">{{ mon.summary.now.curr_connects }}</div>
        </div>
        <div class="kpi">
          <div class="t">Всего трафика</div>
          <div class="v mono">{{ fmtBytes(mon.summary.now.octets_total) }}</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;" v-if="mon.series.length">
        <div>
          <label>Трафик (накопительно)</label>
          <div class="spark" v-html="sparkSvg(mon.series.map(p => p.octets_total), 'bytes')"></div>
        </div>
        <div style="margin-top:10px;">
          <label>Текущие соединения</label>
          <div class="spark" v-html="sparkSvg(mon.series.map(p => p.curr_connects), 'count')"></div>
        </div>
      </div>

      <div style="margin-top:12px;" v-if="(mon.summary.users || []).length">
        <label>Топ пользователей по трафику</label>
        <table style="margin-top:6px;">
          <thead>
            <tr>
              <th>Пользователь</th>
              <th class="right">Трафик</th>
              <th class="right">Сообщения</th>
              <th class="right">Connects</th>
              <th class="right">Current</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="u in mon.summary.users" :key="u.user">
              <td class="mono">{{ u.user }}</td>
              <td class="right mono">{{ fmtBytes(u.octets_total) }}</td>
              <td class="right mono">{{ u.msgs_total }}</td>
              <td class="right mono">{{ u.connects }}</td>
              <td class="right mono">{{ u.curr_connects }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="note" style="margin-top:10px;">
        Данные берутся из встроенного API: <code class="mono">/stats/summary</code> и <code class="mono">/stats/timeseries</code>.
      </div>
    </section>
  </div>

  <div v-if="qrModal.open" class="modal-backdrop" @click.self="closeQr">
    <div class="modal">
      <div class="modal-head">
        <div>
          <div style="font-weight: 600;">QR: <span class="mono">{{ qrModal.user }}</span></div>
          <div class="note" style="margin-top:4px;">Выбери режим и отсканируй QR в Telegram</div>
        </div>
        <button @click="closeQr">Закрыть</button>
      </div>

      <div class="row2" style="margin-bottom:10px;">
        <div>
          <label>Режим</label>
          <select v-model="qrModal.mode" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff;">
            <option v-for="m in qrAvailableModes" :key="m" :value="m">{{ m }}</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button @click="renderQr" :disabled="busy || !qrLink">Обновить QR</button>
        </div>
      </div>

      <div class="qr">
        <div class="qr-box" ref="qrBox" id="qrcode"></div>
        <div>
          <label>Ссылка</label>
          <input type="text" class="mono" :value="qrLink" readonly />
          <div class="actions" style="margin-top:10px;">
            <button class="primary" @click="copyQrLink" :disabled="!qrLink">Копировать</button>
          </div>
          <div class="note" style="margin-top:10px;">Если QR не отображается, проверь что загружена библиотека QRCode (CDN).</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue

createApp({
  data() {
    return {
      apiBase: "",
      busy: false,
      statusText: "", 
      statusKind: "",
      token: "",
      login: { username: "admin", password: "" },
      pw: { old: "", new: "" },
      cfg: {
        port: 443,
        tls_domain: "",
        ad_tag: "",
        modes: { classic: false, secure: true, tls: true },
        users: {}
      },
      newUser: { name: "", secret: "" },
      editUser: { open: false, name: "", secret: "" },
      apiKeys: [],
      keyCreate: { name: "" },
      createdKey: { token: "" }
      ,
      links: [],
      qrModal: { open: false, user: "", mode: "secure" },
      mon: {
        windowMin: 60,
        summary: { now: null, users: [] },
        series: []
      }
    }
  },
  computed: {
    statusClass() {
      if (this.statusKind === "ok") return "ok"
      if (this.statusKind === "err") return "err"
      return ""
    },
    userList() {
      const obj = this.cfg.users || {}
      return Object.keys(obj)
        .sort()
        .map((k) => ({ name: k, secret: String(obj[k]) }))
    }
    ,
    qrAvailableModes() {
      const modes = new Set()
      for (const l of (this.links || [])) {
        if (l.user === this.qrModal.user) modes.add(l.mode)
      }
      const arr = Array.from(modes)
      if (arr.length) return arr
      return ["secure", "tls", "classic"]
    },
    qrLink() {
      const found = (this.links || []).find((l) => l.user === this.qrModal.user && l.mode === this.qrModal.mode)
      return found ? found.link : ""
    }
  },
  methods: {
    endpoint(path) {
      const base = (this.apiBase || "").replace(/\/$/, "")
      if (!base) return path
      return base + path
    },
    setStatus(kind, text) {
      this.statusKind = kind
      this.statusText = text
    },
    async apiFetch(path, opts) {
      const headers = { "Content-Type": "application/json" }
      if (this.token) headers["Authorization"] = `Bearer ${this.token}`
      const res = await fetch(this.endpoint(path), { headers, ...opts })
      const ct = res.headers.get("content-type") || ""
      let body = null
      if (ct.includes("application/json")) body = await res.json()
      else body = await res.text()
      if (!res.ok) {
        const detail = body && body.detail ? body.detail : body
        if (res.status === 401) {
          this.token = ""
          try { localStorage.removeItem("mtproxy_token") } catch (e) {}
        }
        throw new Error(typeof detail === "string" ? detail : JSON.stringify(detail))
      }
      return body
    },
    randomHex32() {
      const arr = new Uint8Array(16)
      crypto.getRandomValues(arr)
      return Array.from(arr).map((b) => b.toString(16).padStart(2, "0")).join("")
    },
    generateSecret() {
      try {
        this.newUser.secret = this.randomHex32()
      } catch (e) {
        this.setStatus("err", "Не удалось сгенерировать secret")
      }
    },
    async doLogin() {
      this.busy = true
      try {
        const payload = { username: this.login.username, password: this.login.password }
        const resp = await this.apiFetch("/auth/login", { method: "POST", body: JSON.stringify(payload) })
        this.token = resp.token
        try { localStorage.setItem("mtproxy_token", this.token) } catch (e) {}
        this.login.password = ""
        await this.refresh()
        this.setStatus("ok", "Вход выполнен")
      } catch (e) {
        this.setStatus("err", "Ошибка входа: " + e.message)
      } finally {
        this.busy = false
      }
    },
    logout() {
      this.token = ""
      this.login.password = ""
      this.pw.old = ""
      this.pw.new = ""
      try { localStorage.removeItem("mtproxy_token") } catch (e) {}
      this.setStatus("", "")
    },
    fmtTs(ts) {
      try {
        return new Date(ts * 1000).toISOString().replace('T', ' ').replace('Z', '')
      } catch (e) {
        return String(ts)
      }
    },
    async changePassword() {
      this.busy = true
      try {
        const payload = { old_password: this.pw.old, new_password: this.pw.new }
        await this.apiFetch("/auth/change-password", { method: "POST", body: JSON.stringify(payload) })
        this.pw.old = ""
        this.pw.new = ""
        this.setStatus("ok", "Пароль изменён")
      } catch (e) {
        this.setStatus("err", "Ошибка смены пароля: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async loadKeys() {
      this.busy = true
      try {
        const keys = await this.apiFetch("/auth/keys", { method: "GET" })
        this.apiKeys = keys
        this.setStatus("ok", "Ключи загружены")
      } catch (e) {
        this.setStatus("err", "Ошибка загрузки ключей: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async createKey() {
      this.busy = true
      try {
        this.createdKey.token = ""
        const payload = { name: this.keyCreate.name || "" }
        const resp = await this.apiFetch("/auth/keys", { method: "POST", body: JSON.stringify(payload) })
        this.createdKey.token = resp.token
        this.keyCreate.name = ""
        await this.loadKeys()
        this.setStatus("ok", "Ключ создан")
      } catch (e) {
        this.setStatus("err", "Ошибка создания ключа: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async deleteKey(id) {
      if (!confirm(`Удалить ключ ${id}?`)) return
      this.busy = true
      try {
        await this.apiFetch(`/auth/keys/${encodeURIComponent(id)}`, { method: "DELETE" })
        await this.loadKeys()
        this.setStatus("ok", "Ключ удалён")
      } catch (e) {
        this.setStatus("err", "Ошибка удаления ключа: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async refresh() {
      this.busy = true
      try {
        const cfg = await this.apiFetch("/config", { method: "GET" })
        this.cfg = cfg
        await this.loadLinks()
        await this.loadKeys()
        this.setStatus("ok", "Загружено")
      } catch (e) {
        this.setStatus("err", "Ошибка загрузки: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async loadLinks() {
      const resp = await this.apiFetch("/links", { method: "GET" })
      this.links = resp.links || []
    },
    async openQr(user) {
      this.busy = true
      try {
        await this.loadLinks()
        this.qrModal.open = true
        this.qrModal.user = user
        const modes = this.qrAvailableModes
        this.qrModal.mode = modes.includes("secure") ? "secure" : modes[0]
        this.$nextTick(() => this.renderQr())
      } catch (e) {
        this.setStatus("err", "Ошибка получения ссылок: " + e.message)
      } finally {
        this.busy = false
      }
    },
    closeQr() {
      this.qrModal.open = false
      this.qrModal.user = ""
    },
    async renderQr() {
      try {
        if (!this.qrLink) return
        const box = this.$refs.qrBox
        if (!box) return
        if (typeof QRCode === "undefined") throw new Error("QRCode library not loaded")
        // clear previous QR
        while (box.firstChild) box.removeChild(box.firstChild)
        new QRCode(box, {
          text: this.qrLink,
          width: 220,
          height: 220,
          correctLevel: QRCode.CorrectLevel.M
        })
      } catch (e) {
        this.setStatus("err", "QR ошибка: " + e.message)
      }
    },
    async copyQrLink() {
      try {
        await navigator.clipboard.writeText(this.qrLink)
        this.setStatus("ok", "Ссылка скопирована")
      } catch (e) {
        this.setStatus("err", "Не удалось скопировать")
      }
    },
    async saveConfig() {
      this.busy = true
      try {
        const payload = JSON.parse(JSON.stringify(this.cfg))
        await this.apiFetch("/config", { method: "PUT", body: JSON.stringify(payload) })
        await this.refresh()
        this.setStatus("ok", "Сохранено и применено")
      } catch (e) {
        this.setStatus("err", "Ошибка сохранения: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async createUser() {
      this.busy = true
      try {
        const payload = { name: this.newUser.name, secret: this.newUser.secret }
        await this.apiFetch("/users", { method: "POST", body: JSON.stringify(payload) })
        this.newUser.name = ""
        this.newUser.secret = ""
        await this.refresh()
        this.setStatus("ok", "Пользователь добавлен")
      } catch (e) {
        this.setStatus("err", "Ошибка добавления: " + e.message)
      } finally {
        this.busy = false
      }
    },
    startEdit(u) {
      this.editUser.open = true
      this.editUser.name = u.name
      this.editUser.secret = u.secret
    },
    cancelEdit() {
      this.editUser.open = false
      this.editUser.name = ""
      this.editUser.secret = ""
    },
    async applyEdit() {
      this.busy = true
      try {
        const payload = { secret: this.editUser.secret }
        await this.apiFetch(`/users/${encodeURIComponent(this.editUser.name)}`, { method: "PUT", body: JSON.stringify(payload) })
        this.cancelEdit()
        await this.refresh()
        this.setStatus("ok", "Пользователь обновлён")
      } catch (e) {
        this.setStatus("err", "Ошибка обновления: " + e.message)
      } finally {
        this.busy = false
      }
    },
    async deleteUser(name) {
      if (!confirm(`Удалить пользователя ${name}?`)) return
      this.busy = true
      try {
        await this.apiFetch(`/users/${encodeURIComponent(name)}`, { method: "DELETE" })
        await this.refresh()
        this.setStatus("ok", "Пользователь удалён")
      } catch (e) {
        this.setStatus("err", "Ошибка удаления: " + e.message)
      } finally {
        this.busy = false
      }
    },
    fmtBytes(n) {
      const v = Number(n || 0)
      const kb = 1024
      const mb = kb * 1024
      const gb = mb * 1024
      if (v >= gb) return (v / gb).toFixed(2) + " GB"
      if (v >= mb) return (v / mb).toFixed(2) + " MB"
      if (v >= kb) return (v / kb).toFixed(2) + " KB"
      return String(Math.floor(v)) + " B"
    },
    fmtDur(sec) {
      let s = Math.max(0, Number(sec || 0))
      const d = Math.floor(s / 86400); s -= d * 86400
      const h = Math.floor(s / 3600); s -= h * 3600
      const m = Math.floor(s / 60); s -= m * 60
      const parts = []
      if (d) parts.push(d + "d")
      if (h || parts.length) parts.push(h + "h")
      if (m || parts.length) parts.push(m + "m")
      parts.push(Math.floor(s) + "s")
      return parts.join(" ")
    },
    sparkSvg(values, kind) {
      const arr = (values || []).map((x) => Number(x || 0))
      if (!arr.length) return ""
      const w = 600, h = 120, pad = 10
      let min = Math.min(...arr)
      let max = Math.max(...arr)
      if (min === max) { max = min + 1 }
      const scaleX = (i) => pad + (i * (w - pad * 2)) / Math.max(1, arr.length - 1)
      const scaleY = (v) => h - pad - ((v - min) * (h - pad * 2)) / (max - min)
      let d = ""
      for (let i = 0; i < arr.length; i++) {
        const x = scaleX(i)
        const y = scaleY(arr[i])
        d += (i === 0 ? "M" : "L") + x.toFixed(1) + "," + y.toFixed(1)
      }
      const last = arr[arr.length - 1]
      const label = (kind === "bytes") ? this.fmtBytes(last) : String(Math.floor(last))
      return `
        <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
          <path d="${d}" fill="none" stroke="rgba(37,99,235,0.9)" stroke-width="2" />
          <text x="${pad}" y="${pad+12}" font-size="12" fill="rgba(100,116,139,1)" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace">${label}</text>
        </svg>
      `.trim()
    },
    async loadMonitoring() {
      const windowMin = Number(this.mon.windowMin || 60)
      const step = windowMin <= 60 ? 10 : (windowMin <= 360 ? 30 : 60)
      const [summary, ts] = await Promise.all([
        this.apiFetch("/stats/summary?limit_users=20"),
        this.apiFetch(`/stats/timeseries?minutes=${encodeURIComponent(windowMin)}&step=${encodeURIComponent(step)}`)
      ])
      this.mon.summary = summary
      this.mon.series = (ts && ts.series) ? ts.series : []
    }
  },
  async mounted() {
    this.setStatus("", "")
    try { this.token = localStorage.getItem("mtproxy_token") || "" } catch (e) {}
    if (this.token) {
      await this.refresh()
      await this.loadKeys()
      await this.loadMonitoring()
    }
  }
}).mount('#app')
</script>
</body>
</html>
